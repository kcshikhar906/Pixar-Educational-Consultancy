rules_version = '2';

service cloud.firestore {
  match /databases/pixareducation/documents {
    
    // Helper function to check if the user is a logged-in admin
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/counselors/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if the user is a logged-in counselor
    function isCounselor() {
      return request.auth != null && get(/databases/$(database)/documents/counselors/$(request.auth.uid)).data.role == 'counselor';
    }
    
    // Helper function to get the full name of the logged-in counselor
    function counselorName() {
      return get(/databases/$(database)/documents/counselors/$(request.auth.uid)).data.name;
    }
    
    // Rules for the 'students' collection
    match /students/{studentId} {
      // Allow read/write for admins
      // Allow read for a counselor if they are assigned to the student
      allow read: if isAdmin() || (isCounselor() && resource.data.assignedTo == counselorName());
      
      // Allow create/update for admins
      // Allow update for a counselor if they are assigned to that student
      allow write: if isAdmin() || (isCounselor() && request.resource.data.assignedTo == counselorName());
      
      // Allow counselors to list students assigned to them
      allow list: if isAdmin() || (isCounselor() && request.query.where.assignedTo == counselorName());
    }
    
    // Rules for the 'counselors' collection
    match /counselors/{userId} {
      // Only admins can read/write counselor roles to prevent privilege escalation
      // A user can read their own role
      allow read: if isAdmin() || request.auth.uid == userId;
      allow write: if isAdmin();
    }
    
    // Default deny for all other collections unless specified
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
